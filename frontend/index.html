<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>トップページ | TODOアプリ</title>
  <!-- cssファイルをimport -->
  <link rel="stylesheet" href="/css/general.css">

  <!-- jsファイルをimport -->
  <script src="/js/general.js"></script>
</head>

<body>
  <div>
    <h1 id="welcome"></h1>
    <button onclick="logout()">ログアウト</button>
  </div>

  <h2>タスク一覧</h2>
  <a href="/tesk-create.html">
    <button>タスクを作成</button>
  </a>

  <div id="task-list">
    <!-- ここにタスクが入る -->
  </div>

</body>

<script>
  // ログインしていない場合、ログインページに移動
  if (!checkLogin()) {
    handleLoginError()
  }

  // ユーザー情報を取得
  const meUrl = `${API_HOST}/me`
  fetch(meUrl, {
    method: 'GET',
    // 認証情報を含める
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('token')}`
    }
  }).then((res) => {
    // 次の処理は.then()メソッドの中で行う
    // レスポンスがokなら、データを取得して次の処理を行う
    if (res.ok) return res.json()

    // エラー処理
    if (res.status === 401) {
      handleLoginError()
    } else {
      alert('予期せむエラーが発生しました')
    }
  }
  ).then(data => {
    document.getElementById('welcome').innerText = `ようこそ、${data.nickname}さん`
  })


  const updateTaskDoneStatus = (taskId, checkboxId) => {
    const checkbox = document.getElementById(checkboxId)

    const url = `${API_HOST}/tasks/${taskId}/done`
    fetch(url, {
      method: checkbox.checked ? 'PUT' : 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    }).then((res) => {
      if (!res.ok) alert('予期せむエラーが発生しました')
    })
  }

  // タスク一覧を取得
  const taskListUrl = `${API_HOST}/tasks`
  fetch(taskListUrl, {
    method: 'GET',
    // 認証情報を含める
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('token')}`
    }
  }).then((res) => {
    // 次の処理は.then()メソッドの中で行う
    // レスポンスがokなら、データを取得して次の処理を行う
    if (res.ok) return res.json()

    // エラー処理
    if (res.status === 401) {
      handleLoginError()
    } else {
      alert('予期せむエラーが発生しました')
    }
  }
  ).then((data) => {
    const taskList = document.getElementById('task-list')
    data.forEach(task => {
      const taskDiv = document.createElement('div')

      taskDiv.innerHTML = `
      <a href="/task-detail.html?taskId=${task.id}">
        <input type="checkbox" id="task-done-checkbox-${task.id}" ${task.done ? 'checked' : ''} onchange="updateTaskDoneStatus(${task.id}, 'task-done-checkbox-${task.id}')">
        ${task.title}
      </a>
      ${task.due_date ? `期限: ${task.due_date}` : ''}
      `
      taskList.appendChild(taskDiv)
    })
  })

</script>

</html>